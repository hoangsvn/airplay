<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="jMuxer H264 Video Stream Demo" name="description"/>
    <title>Live Stream via JMuxer</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #1e1e1e;
            font-family: sans-serif;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 100vh;
            max-width: 100%;
            width: auto;
            height: auto;
            overflow: hidden;
        }

        video {
            display: none;
            max-height: 100vh;
            max-width: 100%;
            width: auto;
            height: auto;
            border: 2px solid #444;
            border-radius: 2px;
            background-color: black;
            transform-origin: center center;
        }

        #status {
            margin-top: 6px;
            font-size: 30px;
            color: #00ff88;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="status">Connecting...</div>
    <video autoplay id="player" muted></video>
</div>
<script src="jmuxer.min.js"></script>
<script>
    window.onload = function () {
        const statusEl = document.getElementById('status');
        const videoEl = document.getElementById('player');
        let hasShownVideo = false;

        const airplay = new JMuxer({
            node: 'player',
            mode: 'video',
            fps: 50,
            flushingTime: 20,
            debug: false
        });

        function rotateVideo(w, h) {
            if (h > w) {
                videoEl.style.transform = 'rotate(90deg)';
                videoEl.style.width = `${h}px`;
                videoEl.style.height = `${w}px`;
                document.getElementById('container').style.width = `${h}px`;
                document.getElementById('container').style.height = `${w}px`;
            } else {
                videoEl.style.transform = 'none';
                videoEl.style.width = 'auto';
                videoEl.style.height = 'auto';
                document.getElementById('container').style.width = 'auto';
                document.getElementById('container').style.height = 'auto';
            }
        }

        function connectStreamWebSocket() {
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 100;
            const reconnectDelay = 3000;
            const stream = new WebSocket('ws://localhost:8081/video');
            stream.binaryType = 'arraybuffer';

            stream.onopen = () => {
                statusEl.textContent = 'Connecting...';
                statusEl.style.color = '#00ff88';
                reconnectAttempts = 0;
            };

            stream.onmessage = (event) => {
                if (event.data instanceof ArrayBuffer) {
                    airplay.feed({video: new Uint8Array(event.data)});
                    if (!hasShownVideo) {
                        videoEl.style.display = 'block';
                        statusEl.style.display = 'none';
                        hasShownVideo = true;
                    }
                } else if (typeof event.data === 'string') {
                    const metadata = JSON.parse(event.data);
                    const w = metadata.width || 1280;
                    const h = metadata.height || 720;
                    rotateVideo(w, h);
                }
            };

            stream.onerror = (error) => {
                console.error('WebSocket video error:', error);
            };

            stream.onclose = () => {
                statusEl.textContent = 'Disconnected ❌ Attempting to reconnect...';
                statusEl.style.color = 'orange';
                videoEl.style.display = 'none';
                statusEl.style.display = 'block';
                hasShownVideo = false;

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        statusEl.textContent = `Reconnecting... attempt ${reconnectAttempts}`;
                        connectStreamWebSocket();
                    }, reconnectDelay);
                } else {
                    statusEl.textContent = 'Failed to reconnect ❌';
                    statusEl.style.color = 'red';
                }
            };
        }

        function connectAudioWebSocket() {
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 100;
            const reconnectDelay = 3000;
            const audio = new WebSocket('ws://localhost:8082/audio');
            audio.binaryType = 'arraybuffer';

            audio.onmessage = (event) => {
                if (event.data instanceof ArrayBuffer) {
                    airplay.feed({audio: new Uint8Array(event.data)});
                }
            };

            audio.onerror = (error) => {
                console.error('WebSocket audio error:', error);
            };

            audio.onclose = () => {
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(() => {
                        connectAudioWebSocket();
                    }, reconnectDelay);
                }
            };
        }

        connectStreamWebSocket();
        // connectAudioWebSocket();
    };
</script>
</body>
</html>